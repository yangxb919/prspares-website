name: Deploy to VPS

on:
  push:
    branches: [ "main", "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BRANCH: ${{ github.ref_name }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          # Uncomment if you use custom SSH port
          # port: ${{ secrets.VPS_PORT }}
          script_stop: true
          envs: APP_DIR,BRANCH,REPO_URL
          script: |
            set -euo pipefail

            echo "=========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° VPS"
            echo "=========================================="

            # Configurable via repo secrets (optional)
            APP_DIR="${APP_DIR:-/var/www/prspares-website}"
            BRANCH="${BRANCH:-main}"
            REPO_URL="${REPO_URL:-}"

            echo "ğŸ“ åº”ç”¨ç›®å½•: $APP_DIR"
            echo "ğŸŒ¿ åˆ†æ”¯: $BRANCH"
            echo ""

            # Ensure NVM/Node 20
            echo "ğŸ“¦ æ£€æŸ¥ Node.js ç¯å¢ƒ..."
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
              echo "âœ… NVM å·²å­˜åœ¨"
            else
              echo "â¬‡ï¸  å®‰è£… NVM...";
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
              . "$NVM_DIR/nvm.sh"
              echo "âœ… NVM å®‰è£…å®Œæˆ"
            fi

            nvm install 20
            nvm use 20
            echo "âœ… Node.js $(node -v) å·²æ¿€æ´»"
            echo ""

            # Ensure PM2
            echo "ğŸ“¦ æ£€æŸ¥ PM2..."
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "â¬‡ï¸  å®‰è£… PM2..."
              npm i -g pm2
              echo "âœ… PM2 å®‰è£…å®Œæˆ"
            else
              echo "âœ… PM2 å·²å­˜åœ¨"
            fi
            echo ""

            # Clone or update repo
            echo "ğŸ“¥ æ›´æ–°ä»£ç ä»“åº“..."
            mkdir -p "$APP_DIR"
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "â¬‡ï¸  é¦–æ¬¡å…‹éš†ä»“åº“..."
              if [ -n "$REPO_URL" ]; then
                git clone --depth=1 --branch "$BRANCH" "$REPO_URL" "$APP_DIR"
              else
                git clone --depth=1 --branch "$BRANCH" "https://github.com/${{ github.repository }}.git" "$APP_DIR"
              fi
              echo "âœ… ä»“åº“å…‹éš†å®Œæˆ"
            else
              echo "ğŸ”„ æ›´æ–°ç°æœ‰ä»“åº“..."
              cd "$APP_DIR"
              git fetch origin "$BRANCH"
              git reset --hard "origin/$BRANCH"
              echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
            fi

            cd "$APP_DIR"
            echo "ğŸ“ å½“å‰æäº¤: $(git log -1 --oneline)"
            echo ""

            # Link production env if stored in shared path (recommended)
            if [ -f "$APP_DIR/shared/.env.production" ] && [ ! -f "$APP_DIR/.env.production" ]; then
              echo "ğŸ”— é“¾æ¥ç”Ÿäº§ç¯å¢ƒé…ç½®..."
              ln -sf "$APP_DIR/shared/.env.production" "$APP_DIR/.env.production"
              echo "âœ… ç¯å¢ƒé…ç½®å·²é“¾æ¥"
            fi
            echo ""

            # Install deps and build
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            export HUSKY=0
            npm ci
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            echo ""

            echo "ğŸ”¨ æ„å»ºåº”ç”¨..."
            npm run build:fast
            echo "âœ… æ„å»ºå®Œæˆ"
            echo ""

            # Start or reload via PM2
            echo "ğŸš€ å¯åŠ¨/é‡è½½åº”ç”¨..."
            if [ -f ecosystem.config.cjs ]; then
              pm2 startOrReload ecosystem.config.cjs --only prspares-website --env production
            else
              # å…ˆå°è¯•åˆ é™¤æ—§è¿›ç¨‹
              pm2 delete prspares-website 2>/dev/null || true
              # å¯åŠ¨æ–°è¿›ç¨‹
              pm2 start node_modules/next/dist/bin/next --name prspares-website -- start -p 3000
            fi
            pm2 save
            echo "âœ… PM2 è¿›ç¨‹å·²æ›´æ–°"
            echo ""

            # Wait for app to start
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 3
            echo ""

            # Health check
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            HTTP_STATUS=$(curl -I -sS http://127.0.0.1:3000/ 2>&1 | head -n 1)
            if echo "$HTTP_STATUS" | grep -q "200\|301\|302"; then
              echo "âœ… åº”ç”¨è¿è¡Œæ­£å¸¸: $HTTP_STATUS"
            else
              echo "âš ï¸  åº”ç”¨å“åº”å¼‚å¸¸: $HTTP_STATUS"
              echo "ğŸ“‹ PM2 è¿›ç¨‹çŠ¶æ€:"
              pm2 list
              echo ""
              echo "ğŸ“‹ æœ€è¿‘çš„é”™è¯¯æ—¥å¿—:"
              pm2 logs prspares-website --err --lines 10 --nostream || true
              exit 1
            fi

            echo ""
            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
